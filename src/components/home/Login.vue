<script setup lang="ts">
import { Button } from '@/components/ui/button'
import { FormControl, FormField, FormItem, FormLabel } from '@/components/ui/form'
import { Input } from '@/components/ui/input'
import { loginPostSchema } from '@/types/Login.ts'
import { useForm } from 'vee-validate'
import { useRouter } from 'vue-router'
import { toTypedSchema } from '@vee-validate/zod'
import { postLogin } from '@/api/postLogin'
import { UserStore } from '@/store/userStore'
import { useToast } from '@/components/ui/toast'
import { ref } from 'vue'

const router = useRouter()
const userStore = UserStore()
const { toast } = useToast()
const isLoading = ref(false)

const validationSchema = toTypedSchema(loginPostSchema)

const { handleSubmit } = useForm({
  validationSchema
})

const onSubmit = handleSubmit(async (values) => {
  try {
    isLoading.value = true

    await postLogin(values)

    userStore.setUsername()
    await router.push({ name: 'Profil', params: { username: userStore.username } })
  } catch (error) {
    toast({
      title: "Quelques chose n'a pas fonctionn√©.",
      description: error.message,
      variant: 'destructive'
    })
  } finally {
    isLoading.value = false
  }
})
</script>

<template>
  <form class="space-y-6" @submit="onSubmit">
    <FormField
      v-slot="{ componentField }"
      name="email"
      :validate-on-change="false"
      :validate-on-input="false"
      :validate-on-blur="false"
      :validate-on-mount="false"
      :validate-on-model-update="false"
    >
      <FormItem>
        <FormLabel>Email</FormLabel>
        <FormControl>
          <Input type="email" placeholder="Votre email" v-bind="componentField" />
        </FormControl>
      </FormItem>
    </FormField>

    <FormField
      v-slot="{ componentField }"
      name="password"
      :validate-on-change="false"
      :validate-on-input="false"
      :validate-on-blur="false"
      :validate-on-mount="false"
      :validate-on-model-update="false"
    >
      <FormItem>
        <FormLabel>Mot de passe</FormLabel>
        <FormControl>
          <Input type="password" placeholder="Votre mot de passe" v-bind="componentField" />
        </FormControl>
      </FormItem>
    </FormField>

    <Button type="submit" size="form" :disabled="isLoading">
      {{ isLoading ? 'Connexion en cours...' : 'Se connecter ' }}
    </Button>
  </form>
</template>
